<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <title>{{post.title}} | {{site.title}}</title>
    <meta name="description" content="{{post.excerpt}}" />
    
    <link rel="stylesheet" href="/assets/dist/main.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    
    <!-- Fonts -->
    <link rel="stylesheet" href="/assets/fonts/HarmonyOS_Sans_SC/main.css" />
    <link rel="preconnect" href="https://fontsapi.zeoseven.com" crossorigin />
    <link
      rel="stylesheet"
      href="https://fontsapi.zeoseven.com/292/main/result.css"
      onerror="this.href='https://fontsapi-storage.zeoseven.com/292/main/result.css'"
    />
    <link
      rel="stylesheet"
      href="https://fontsapi.zeoseven.com/285/main/result.css"
      onerror="this.href='https://fontsapi-storage.zeoseven.com/285/main/result.css'"
    />
    <link
      rel="stylesheet"
      href="https://fontsapi.zeoseven.com/442/main/result.css"
      onerror="this.href='https://fontsapi-storage.zeoseven.com/442/main/result.css'"
    />
    
    <script src="/assets/dist/main.iife.js"></script>
  </head>

  <body>
    <header>
      <nav class="mb-[32px] flex border-b border-[#ddd] py-[14px] font-mono" id="navigation">
        <a href="/">{{site.title}}</a>
        <div class="ml-auto flex flex-row gap-5">
          <a href="/">首页</a>
          <a href="/archives.html">归档</a>
          <a href="/categories.html">分类</a>
          <span> | </span>
          <a href="javascript:SearchWidget.open()">
            <span class="icon-[fa-solid--search] iconify-inline"></span>
          </a>
        </div>
      </nav>
    </header>

    <article>
      <!-- 标题 -->
      <div class="text-center font-serif text-[2rem] font-bold">{{post.title}}</div>

      <!-- 元信息 -->
      <div class="mt-4 mb-8 text-center text-sm text-gray-600">
        <div class="flex items-center justify-center gap-4">
          <time>{{post.created_at}}</time>
          <span>作者: {{post.author}}</span>
          <a href="{{post.github_url}}" target="_blank" class="text-blue-600 hover:underline">
            在 GitHub 上查看
          </a>
        </div>
        
        <!-- 标签/分类 -->
        <div class="mt-2 flex justify-center gap-2">
          {{post.labels.map(label => `<span class="category" style="background-color: #${label.color}20; color: #${label.color}; border: 1px solid #${label.color}40">${label.name}</span>`).join('')}}
        </div>
      </div>

      <section class="relative">
        <div id="post-content">{{post.content}}</div>

        <!-- 版权许可协议 -->
        <div class="card mt-14 px-6 py-4" id="license">
          <div class="font-bold">{{post.title}}</div>
          <div class="license-item mt-1">{{site.url}}{{post.url}}</div>
          <div class="license-item mt-1">
            本文采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议
          </div>
        </div>

        <!-- 目录 -->
        <aside class="absolute top-0 right-[-160px] hidden h-full w-[120px] md:block">
          <nav class="sticky top-10 pl-4 font-serif text-[0.8rem]" id="toc"></nav>
        </aside>
      </section>

      <!-- GitHub 评论系统 -->
      <div class="mt-16" id="comments-section">
        <h3 class="mb-4 text-xl font-bold">评论</h3>
        
        <!-- 登录提示 -->
        <div id="login-prompt" class="mb-4 p-4 bg-gray-100 rounded">
          <p class="mb-2">要发表评论，请先登录 GitHub：</p>
          <button id="github-login" class="btn bg-black text-white px-4 py-2 rounded">
            <span class="icon-[mingcute--github-line] iconify-inline mr-2"></span>
            使用 GitHub 登录
          </button>
        </div>

        <!-- 评论表单 -->
        <div id="comment-form" class="mb-6 hidden">
          <textarea 
            id="comment-text" 
            placeholder="写下你的评论..." 
            class="w-full p-3 border rounded resize-none"
            rows="4"
          ></textarea>
          <div class="mt-2 flex justify-end gap-2">
            <button id="cancel-comment" class="btn px-4 py-2 border rounded">取消</button>
            <button id="submit-comment" class="btn bg-blue-600 text-white px-4 py-2 rounded">发表评论</button>
          </div>
        </div>

        <!-- 现有评论 -->
        <div id="comments-list">
          {{post.comments}}
        </div>
      </div>
    </article>

    <footer class="pt-20 pb-6">
      <div class="flex flex-col items-center gap-1">
        <div>© <span id="current-year"></span> · {{site.author}}</div>
        <div>Powered by <a href="https://github.com/{{site.author}}/{{github.repo}}">GitHub Issues</a></div>
      </div>
    </footer>

    <script>
      document.getElementById('current-year').textContent = new Date().getFullYear();
      
      document.addEventListener("DOMContentLoaded", () => {
        if (typeof main !== 'undefined') {
          main.generateTOC && main.generateTOC();
          main.scrollHighlightTOC && main.scrollHighlightTOC();
          main.clickHighlightTOC && main.clickHighlightTOC();
          main.wordCountAndReadTime && main.wordCountAndReadTime();
          main.generateTimeTips && main.generateTimeTips();
          main.addIconToLinks && main.addIconToLinks();
        }
        
        // GitHub 评论系统
        initGitHubComments();
      });

      function initGitHubComments() {
        const loginBtn = document.getElementById('github-login');
        const commentForm = document.getElementById('comment-form');
        const loginPrompt = document.getElementById('login-prompt');
        
        // 检查是否已登录
        const token = localStorage.getItem('github_token');
        if (token) {
          showCommentForm();
        }
        
        loginBtn.addEventListener('click', () => {
          // GitHub OAuth 登录流程
          const clientId = 'your_github_app_client_id'; // 需要配置
          const redirectUri = window.location.origin + '/auth/callback';
          const scope = 'public_repo';
          
          window.location.href = `https://github.com/login/oauth/authorize?client_id=${clientId}&redirect_uri=${redirectUri}&scope=${scope}`;
        });
        
        function showCommentForm() {
          loginPrompt.classList.add('hidden');
          commentForm.classList.remove('hidden');
        }
        
        // 提交评论
        document.getElementById('submit-comment').addEventListener('click', async () => {
          const commentText = document.getElementById('comment-text').value;
          if (!commentText.trim()) return;
          
          try {
            const response = await fetch(`https://api.github.com/repos/{{github.owner}}/{{github.repo}}/issues/{{post.id}}/comments`, {
              method: 'POST',
              headers: {
                'Authorization': `token ${localStorage.getItem('github_token')}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ body: commentText })
            });
            
            if (response.ok) {
              location.reload(); // 刷新页面显示新评论
            } else {
              alert('评论发表失败，请重试');
            }
          } catch (error) {
            console.error('Error posting comment:', error);
            alert('评论发表失败，请重试');
          }
        });
      }
    </script>
  </body>
</html>
